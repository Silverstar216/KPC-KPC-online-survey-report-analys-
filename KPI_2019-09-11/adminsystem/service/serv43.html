<?php
  if (!defined('_GNUBOARD_')) exit; // 개별 페이지 접근 불가   

$page_size = 20;
$colspan = 7;

$token = get_token();

$g5['title'] = "휴대폰번호 관리";

if ($page < 1) $page = 1;

if (is_numeric($bg_no))
    $sql_group = " and booktable.bg_no='$bg_no' ";
else
    $sql_group = "";

if ($st == 'all') {
    $sql_search = "and (bk_name like '%{$sv}%' or bk_hp like '%{$sv}%')";
} else if ($st == 'name') {
    $sql_search = "and bk_name like '%{$sv}%'";
} else if ($st == 'hp') {
    $sql_search = "and bk_hp like '%{$sv}%'";
} else {
    $sql_search = '';
}

if ($ap > 0)
    $sql_korean = korean_index('bk_name', $ap-1);
else {
    $sql_korean = '';
    $ap = 0;
}

if ($no_hp == 'yes') {
    set_cookie('cookie_no_hp', 'yes', 60*60*24*365);
    $no_hp_checked = 'checked';
} else if ($no_hp == 'no') {
    set_cookie('cookie_no_hp', '', 0);
    $no_hp_checked = '';
} else {
    if (get_cookie('cookie_no_hp') == 'yes')
        $no_hp_checked = 'checked';
    else
        $no_hp_checked = '';
}

if ($no_hp_checked == 'checked')
    $sql_no_hp = "and bk_hp <> ''";

$total_res = sql_fetch("select count(*) as cnt from {$g5['sms5_book_table']} as booktable where mb_no = '{$member['mb_no']}' $sql_group $sql_search $sql_korean $sql_no_hp");
$total_count = $total_res['cnt'];

$total_page = (int)($total_count/$page_size) + ($total_count%$page_size==0 ? 0 : 1);
$page_start = $page_size * ( $page - 1 );

$vnum = $total_count - (($page-1) * $page_size);

$res = sql_fetch("select count(*) as cnt from {$g5['sms5_book_table']} as booktable  where mb_no = '{$member['mb_no']}' and bk_receipt=1 $sql_group $sql_search $sql_korean $sql_no_hp");
$receipt_count = $res['cnt'];
$reject_count = $total_count - $receipt_count;

$res = sql_fetch("select count(*) as cnt from {$g5['sms5_book_table']} as booktable  where mb_no = '{$member['mb_no']}'  and mb_id='' $sql_group $sql_search $sql_korean $sql_no_hp");
$no_member_count = $res['cnt'];
$member_count = $total_count - $no_member_count;

$no_group = sql_fetch("select bg_no,bg_name,bg_count,bg_member,bg_nomember,
ifnull((select count(*) from {$g5['sms5_book_table']} as booktable where booktable.bg_no = 1 and mb_no = '{$member['mb_no']}' and bk_receipt= 1),0) as bg_receipt,    
bg_reject from {$g5['sms5_book_group_table']} where bg_no = 1");

$group = array();
$qry = sql_query("select bg_no,bg_name,bg_count,bg_member,bg_nomember,
ifnull((select count(*) from {$g5['sms5_book_table']} as booktable  
    where booktable.bg_no = w.bg_no and mb_no = '{$member['mb_no']}' and bk_receipt= 1),0) as bg_receipt,    
bg_reject from {$g5['sms5_book_group_table']} as w where bg_no>1 and bg_member = '{$member['mb_no']}' order by bg_name");

while ($res = sql_fetch_array($qry)) array_push($group, $res);
?>
<script>

function book_all_checked(chk)
{
    if (chk) {
        jQuery('[name="bk_no[]"]').attr('checked', true);
    } else {
        jQuery('[name="bk_no[]"]').attr('checked', false);
    }
}
</script>
   <div class="subTopTab">
    <ul class="item">
        <li><a href="#" title="페이지 이동" class="active"><span>휴대폰 번호</span></a></li>
           
    </ul>
    </div>

<div class="titlegroup">
        <em>휴대폰 번호</em>      
         <div class="navgroup">     
                 <p>Home <span class="rt">&gt;</span> 전화번호관리 <span class="rt">&gt;</span> 휴대폰 번호</p>
        </div>     
</div>
<!-- 휴대폰번호 -->
<div class="phonegroup">
<div class="phonegroupin">
<div class="phonegroupwrap">
<div class="local_ov01 local_ov">
    <span class="ov_listall">총 건수 <?php echo number_format($total_count)?>명</span>
</div>

<form name="search_form" method="get" action="<?php echo $_SERVER['PHP_SELF']?>" class="local_sch01 local_sch">
<input type="hidden" name="bg_no" value="<?php echo $bg_no?>" >
<input type="hidden" name="m1" value="4" >
<input type="hidden" name="m2" value="3" >
<label for="st" class="sound_only">검색대상</label>
<select name="st" id="st">
    <option value="all"<?php echo get_selected('all', $st); ?>>이름 + 휴대폰번호</option>
    <option value="name"<?php echo get_selected('name', $st); ?>>이름</option>
    <option value="hp" <?php echo get_selected('hp', $st); ?>>휴대폰번호</option>
</select>
<label for="sv" class="sound_only">검색어<strong class="sound_only"> 필수</strong></label>
<input type="text" name="sv" value="<?php echo $sv?>" id="sv" required class="frm_input required">
<input type="submit" value="검색" class="btnW2">
</form>

<form name="search_form" class="local_sch01 local_sch">
<label for="bg_no" class="sound_only">그룹명</label>
<select name="bg_no" id="bg_no" onchange="location.href='/serv.php?m1=4&m2=3&bg_no='+this.value;">
    <option value=""<?php echo get_selected('', $bg_no); ?>> 전체 </option>
    <?php for($i=0; $i<count($group); $i++) {?>
    <option value="<?php echo $group[$i]['bg_no']?>"<?php echo get_selected($bg_no, $group[$i]['bg_no']);?>> <?php echo $group[$i]['bg_name']?> (<?php echo number_format($group[$i]['bg_receipt'])?> 명) </option>
    <?php } ?>
</select>
</form>

<div class="btn_add01 btn_add">
    <a href="/service/num_book_write.php?page=<?php echo $page?>&amp;bg_no=<?php echo $bg_no?>">번호추가</a>
</div>

<form name="hp_manage_list" id="hp_manage_list" method="post" action="/service/num_book_multi_update.php" onsubmit="return hplist_submit(this);" >
<input type="hidden" name="page" value="<?php echo $page; ?>">
<input type="hidden" name="token" value="<?php echo $token; ?>">
<input type="hidden" name="sw" value="">
<input type="hidden" name="atype" value="del">
<input type="hidden" name="str_query" value="<?php echo $_SERVER['QUERY_STRING']?>" >

<div class="tbl_head01 tbl_wrap">
    <table>
    <caption><?php echo $g5['title']; ?> 목록</caption>
      <colgroup>
            <col width="2%" />
            <col width="6%" />
            <col width="*" />
            <col width="12%" />
            <col width="16%" />
            <col width="16%" />                                         
            <col width="22%" />
     </colgroup>     
    <thead>
    <tr>
        <th scope="col">
            <label for="chk_all" class="sound_only">현재 페이지 전체</label>
            <input type="checkbox" id="chk_all" onclick="book_all_checked(this.checked)">
        </th>
        <th scope="col" >번호</th>
        <th scope="col" >그룹</th>
        <th scope="col">이름</th>
        <th scope="col" >휴대폰</th>
        <th scope="col" >학년 반 번호</th>
        <th scope="col" >관리</th>
    </tr>
    </thead>
    <tbody>
    <?php if (!$total_count) { ?>
    <tr>
        <td colspan="<?php echo $colspan?>" class="empty_table">데이터가 없습니다.</td>
    </tr>
    <?php
    }	
	
    $line = 0;
    $qry = sql_query("select ifnull(gr.bg_name,'그룹없음') as bg_name ,booktable.* from {$g5['sms5_book_table']} as booktable left outer join {$g5['sms5_book_group_table']} as gr on gr.bg_no= booktable.bg_no ".
        "where mb_no = '{$member['mb_no']}' $sql_group $sql_search $sql_korean $sql_no_hp order by bk_name limit $page_start, $page_size");
    while($res = sql_fetch_array($qry))
    {
        $bg = 'bg'.($line++%2);

//        $tmp = sql_fetch("select bg_name from {$g5['sms5_book_group_table']} where bg_no='{$res['bg_no']}'");
//        $group_name = $tmp['bg_name'];
        $group_name = $res['bg_name'];        
        $tinfo = '';
        if ($res['bk_grade'] <> '') {
            if ($res['bk_class'] <> '') {
                if ($res['bk_stid'] <> '') {
                    if ($res['bk_kind'] == 1) {
                            $tinfo = $res['bk_grade'].'학년'.$res['bk_class'].'반 '.$res['bk_stid'].'번 (학부모)';
                    } else {
                            $tinfo = $res['bk_grade'].'학년'.$res['bk_class'].'반 '.$res['bk_stid'].'번 (학생)';
                    }
                }
            }
        }
    ?>
    <tr class="<?php echo $bg; ?>">
        <td class="td_chk">
            <label for="bk_no_<?php echo $i; ?>" class="sound_only"><?php echo $group_name?>의 <?php echo $res['bk_name']?></label>
            <input type="checkbox" name="bk_no[]" value="<?php echo $res['bk_no']?>" id="bk_no_<?php echo $i; ?>">
        </td>
        <td class="td_num"><?php echo number_format($vnum--)?></td>
        <td><?php echo $group_name?></td>
        <td class="td_mbname"><?php echo $res['bk_name']?></td>
        <td class="td_numbig"><?php echo $res['bk_hp']?></td>
        <td class="td_mbname"><?php echo $tinfo?></td>
        <td >
            <a href="/service/num_book_write.php?w=u&amp;bk_no=<?php echo $res['bk_no']?>&amp;page=<?php echo $page?>&amp;bg_no=<?php echo $bg_no?>&amp;st=<?php echo $st?>&amp;sv=<?php echo $sv?>&amp;ap=<?php echo $ap?>" class="btnG2">수정</a>
            <a href="/serv.php?m1=4&m2=1&bk_no=<?php echo $res['bk_no']?>" class="btnG2">보내기</a>
            <a href="/service/history_num.php?st=hs_hp&amp;sv=<?php echo $res['bk_hp']?>" class="btnG2">내역</a>
        </td>
    </tr>
    <?php } ?>
    </tbody>
    </table>
</div>

<div class="btn_list01 btn_list">
    <input type="submit" name="act_button" value="선택삭제" onclick="document.pressed=this.value">
    <input type="submit" name="act_button" value="선택이동" onclick="document.pressed=this.value">
</div>
</form>
</div>
</div>
</div>
<!-- 휴대폰번호 -->
<script>
function hplist_submit(f){
    if (!is_checked("bk_no[]")) {
        alert(document.pressed+" 하실 항목을 하나 이상 선택하세요.");
        return false;
    }
    if(document.pressed == "선택이동") {
        select_copy("move", f);
        return;
    }
    if(document.pressed == "선택삭제") {
        if(!confirm("선택한 자료를 정말 삭제하시겠습니까?")) {
            return false;
        }
    }
<?php if ($is_guest) {?>
      alert("로그인 후 사용가능합니다.");
      document.location.replace("<?php echo G5_BBS_URL.'/login.php?url='.urlencode(G5_URL.'/serv.php?m1='.$pgMNo.'&m2='.$pgMNo1) ?>");
      return false;
<?php } else {?>             
    return true;
<?php } ?>             
}
// 선택한 이모티콘 그룹 이동
function select_copy(sw, f) {
    if( !f ){
        var f = document.emoticonlist;
    }
    if (sw == "copy")
        str = "복사";
    else
        str = "이동";
<?php if ($is_guest) {?>
      alert("로그인 후 사용가능합니다.");
      document.location.replace("<?php echo G5_BBS_URL.'/login.php?url='.urlencode(G5_URL.'/serv.php?m1='.$pgMNo.'&m2='.$pgMNo1) ?>");
      return false;
<?php } else {?>             
    f.sw.value = sw;
    f.action = "/service/num_book_move.php";
    f.submit();
<?php } ?>                 
}
</script>
<?php echo get_paging(G5_IS_MOBILE ? $config['cf_mobile_pages'] : $config['cf_write_pages'], $page, $total_page, $_SERVER['PHP_SELF']."?m1=4&m2=3&bg_no=$bg_no&amp;st=$st&amp;sv=$sv&amp;ap=$ap&amp;page="); ?>
</div>